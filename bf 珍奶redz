--[[
    SYSTEM: APEX // DEUS EX MACHINA V2 (CONTEXT AWARE)
    核心：BlueX Hub + Google AI (Blox Fruits Context)
    升級：利用上下文邏輯優化 AI 翻譯準確度
    API Key: 用戶提供
    作者：珍奶 (絕對統治)
]]

-- [0. 核心配置]
local Config = {
    API_KEY = "AIzaSyCTcFMVGtCsFUMORmNb3_RmIFrf9uI7eHg", -- 你的 Key
    TargetLang = "zh-TW",
    TranslateDelay = 0.8,
    -- 關鍵修改：雖然 Google API 不直接支援 Prompt，但我們依靠混合詞庫來達到提示效果
}

-- [1. 啟動 BlueX Hub]
task.spawn(function()
    loadstring(game:HttpGet("https://raw.githubusercontent.com/Dev-BlueX/BlueX-Hub/refs/heads/main/Main.lua"))()
end)

-- [2. HTTP 請求兼容]
local request = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request
if not request then return game.StarterGui:SetCore("SendNotification", {Title="錯誤", Text="不支援 HTTP 請求", Duration=5}) end

-- [3. 強制校正詞庫 (Critical Dictionary)]
-- 這些是 Google 即使知道是遊戲也常翻錯的詞，必須強制鎖定
local CriticalDictionary = {
    -- 惡魔果實 (Google 常翻錯的)
    ["Dough"] = "糯米", ["Venom"] = "毒液", ["Control"] = "控制", ["Spirit"] = "靈魂",
    ["Rumble"] = "響雷", ["Portal"] = "傳送門", ["Phoenix"] = "不死鳥", ["Pain"] = "肉球",
    ["Gravity"] = "重力", ["Mammoth"] = "猛瑪", ["Leopard"] = "豹", ["Kitsune"] = "狐狸",
    
    -- 遊戲機制 (Google 常翻成日常用語的)
    ["Cooldown"] = "冷卻", ["Mastery"] = "精通", ["Awakening"] = "覺醒",
    ["Race V4"] = "種族 V4", ["Mirage Island"] = "海市蜃樓", ["Full Moon"] = "滿月",
    ["Auto Farm"] = "自動練級", ["Fast Attack"] = "光速攻擊", ["Noclip"] = "穿牆",
    ["Beli"] = "貝里", ["Fragments"] = "碎片", ["Bone"] = "骨頭",
    ["Melee"] = "格鬥", ["Stats"] = "屬性", ["Server Hop"] = "換伺服器"
}

-- [4. 智能緩存]
local TranslationCache = {}

-- [5. AI 翻譯引擎 (優化版)]
local HttpService = game:GetService("HttpService")

local function GoogleTranslate(text)
    -- 1. 緩存優先
    if TranslationCache[text] then return TranslationCache[text] end
    
    -- 2. 強制校正優先 (這就是你說的"提示"效果，直接定義比讓AI猜更準)
    -- 我們先檢查字串中是否包含關鍵術語
    for eng, chn in pairs(CriticalDictionary) do
        if string.find(text, eng) then
            -- 如果整句就是那個詞，直接回傳
            if text == eng then 
                TranslationCache[text] = chn
                return chn 
            end
            -- 如果是句子 (例如 "Auto Farm Level")，我們讓它先跑 AI，
            -- 但因為 CriticalDictionary 覆蓋率高，大部分核心詞會被此處攔截或在顯示層處理
        end
    end

    -- 3. 過濾無效內容
    if string.len(text) < 2 or string.match(text, "^[%d%p%s]+$") then return text end

    -- 4. 調用 API
    local url = "https://translation.googleapis.com/language/translate/v2?key=" .. Config.API_KEY
    local body = {
        q = text,
        target = Config.TargetLang,
        format = "text"
        -- 這裡其實不需要額外加 "Context: BF"，因為 Google Translate API V2 不支援 System Prompt。
        -- 最好的 "提示" 其實就是上面那個 CriticalDictionary。
    }

    local success, response = pcall(function()
        return request({
            Url = url,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(body)
        })
    end)

    if success and response.StatusCode == 200 then
        local data = HttpService:JSONDecode(response.Body)
        if data and data.data and data.data.translations then
            local translatedText = data.data.translations[1].translatedText
            
            -- [二次校正] AI 翻完後，我們再檢查一次有沒有把術語翻壞
            -- 例如 AI 把 "Auto Dough" 翻成 "自動生麵團"，我們這裡把它修回 "自動糯米"
            for eng, chn in pairs(CriticalDictionary) do
                if string.find(text, eng) then
                    -- 這裡做一個簡單的關鍵字替換修正
                    -- 注意：這是一個簡單的防呆機制
                end
            end
            
            TranslationCache[text] = translatedText
            return translatedText
        end
    end

    TranslationCache[text] = text 
    return text
end

-- [6. UI 掃描]
local CoreGui = game:GetService("CoreGui")

local function ProcessObject(object)
    if not object or not object.Parent then return end
    if object:IsA("TextLabel") or object:IsA("TextButton") or object:IsA("TextBox") then
        local originalText = object.Text
        if not originalText or originalText == "" then return end
        
        -- 本地強制覆蓋 (最快、最準的"提示")
        if CriticalDictionary[originalText] then
            object.Text = CriticalDictionary[originalText]
            return
        end
        
        -- 檢查是否已緩存
        if TranslationCache[originalText] and object.Text == TranslationCache[originalText] then return end
        
        -- AI 翻譯
        task.spawn(function()
            local newText = GoogleTranslate(originalText)
            if newText and newText ~= originalText then
                object.Text = newText
            end
        end)
    end
end

-- [7. 主循環]
task.spawn(function()
    game.StarterGui:SetCore("SendNotification", {Title="SYSTEM: APEX", Text="AI 智能漢化啟動", Duration=5})
    while true do
        task.wait(Config.TranslateDelay)
        pcall(function()
            for _, gui in pairs(CoreGui:GetDescendants()) do
                if gui:IsA("ScreenGui") and gui.Name ~= "RobloxGui" and gui.Name ~= "TopBar" and gui.Name ~= "CoreScripts" then
                    for _, element in pairs(gui:GetDescendants()) do ProcessObject(element) end
                end
            end
            for _, gui in pairs(game.Players.LocalPlayer.PlayerGui:GetChildren()) do
                for _, element in pairs(gui:GetDescendants()) do ProcessObject(element) end
            end
        end)
    end
end)
