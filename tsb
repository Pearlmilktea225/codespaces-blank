--[[
    珍奶腳本 (ZhenNai Hub) - v29.0 終焉神話版 (SYSTEM: MYTHOLOGY)
    集大成：TSB 專屬技能 + 實戰甩飛傷害 + 雙端適配 + 極致優化
    支援角色：琦玉 / 宇宙餓狼 / 宿儺
]]

-- [1. 系統初始化 System Init]
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- 裝置偵測
local IsMobile = UserInputService.TouchEnabled
local PlatformName = IsMobile and "MOBILE" or "PC"

-- 清理舊實例
for _, gui in pairs(CoreGui:GetChildren()) do
    if gui.Name == "ZhenNai_HUD_v29" or gui.Name == "Fluent" then gui:Destroy() end
end
if LocalPlayer.Character then
    for _, x in pairs(LocalPlayer.Character:GetDescendants()) do
        if x.Name:find("ZN_") then x:Destroy() end
    end
    for _, x in pairs(workspace:GetChildren()) do
        if x.Name == "ZN_FX" or x.Name == "ZN_Visual_Part" then x:Destroy() end
    end
end
Lighting:ClearAllChildren() -- 清理光影濾鏡

local Fluent = loadstring(game:HttpGet("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua"))()

-- [2. 全局配置 Config]
local Config = {
    -- 戰鬥核心
    TargetName = "", CurrentTarget = nil,
    Mode = "None", -- Saitama, Garou, Sukuna
    RealDamage = false, -- 是否開啟物理甩飛傷害
    Hitbox = false, HitboxSize = 20,
    
    -- 視覺特效
    Visuals = true, RGB = false, MagicCircle = true,
    CamShake = true, ScreenFX = true,
    
    -- 生存與機動
    Speed = 100, SpeedEnabled = false, Noclip = false, Invisible = false,
    AntiVoid = true, VoidHeight = -50,
}

--------------------------------------------------------------------------------
-- 3. 物理引擎 (Physics Engine) - 傷害與防護
--------------------------------------------------------------------------------

-- [物理甩飛 - 造成傷害的核心]
local function ActivateFling(root)
    -- 清理
    for _, x in pairs(root:GetChildren()) do if x.Name:find("ZN_Phys") then x:Destroy() end end
    -- 注入極限物理
    local BAV = Instance.new("BodyAngularVelocity", root); BAV.Name="ZN_Phys_Spin"; BAV.MaxTorque=Vector3.new(9e9,9e9,9e9); BAV.AngularVelocity=Vector3.new(0,100000,0)
    local BV = Instance.new("BodyVelocity", root); BV.Name="ZN_Phys_Lift"; BV.MaxForce=Vector3.new(9e9,9e9,9e9); BV.Velocity=Vector3.new(0,0,0)
    Config.Noclip = true -- 攻擊時必須穿牆
end

local function DeactivateFling(root)
    for _, x in pairs(root:GetChildren()) do if x.Name:find("ZN_Phys") then x:Destroy() end end
    root.Velocity = Vector3.zero
    root.RotVelocity = Vector3.zero
end

-- [實戰攻擊邏輯]
local function ExecuteRealDamage(duration)
    if not Config.RealDamage or not Config.CurrentTarget then return end
    local Char = LocalPlayer.Character
    local TChar = Config.CurrentTarget.Character
    if not Char or not TChar then return end
    
    local Root = Char:FindFirstChild("HumanoidRootPart")
    local TRoot = TChar:FindFirstChild("HumanoidRootPart")
    if not Root or not TRoot then return end

    -- 啟動
    ActivateFling(Root)
    
    -- 追蹤攻擊 (持續 duration 秒)
    local start = tick()
    task.spawn(function()
        while tick() - start < duration do
            if not Config.RealDamage then break end
            -- 瞬移到目標內部進行物理碰撞
            Root.CFrame = TRoot.CFrame * CFrame.new(math.random(-1,1), math.random(-1,1), math.random(-1,1))
            RunService.RenderStepped:Wait()
        end
        DeactivateFling(Root)
    end)
end

--------------------------------------------------------------------------------
-- 4. 視覺引擎 (Visual Engine) - 特效與皮膚
--------------------------------------------------------------------------------
local function PlayAudio(id, vol, pitch)
    local s = Instance.new("Sound", workspace); s.SoundId="rbxassetid://"..id; s.Volume=vol or 2; s.PlaybackSpeed=pitch or 1
    s:Play(); Debris:AddItem(s, 5)
end

local function Shake(intensity)
    if not Config.CamShake then return end
    task.spawn(function()
        for i=1, 8 do
            Camera.CFrame = Camera.CFrame * CFrame.new(math.random(-1,1)*(intensity/10), math.random(-1,1)*(intensity/10), 0)
            RunService.RenderStepped:Wait()
        end
    end)
end

local function CreateShockwave(pos, color, size, time)
    local p = Instance.new("Part", workspace); p.Name="ZN_FX"; p.Shape="Ball"; p.Material="Neon"; p.Color=color; p.Size=Vector3.new(1,1,1); p.CFrame=CFrame.new(pos); p.Anchored=true; p.CanCollide=false; p.Transparency=0.2
    TweenService:Create(p, TweenInfo.new(time), {Size=Vector3.new(size,size,size), Transparency=1}):Play()
    Debris:AddItem(p, time)
end

-- [宇宙餓狼皮膚]
local function ApplyCosmicSkin(char)
    for _, v in pairs(char:GetChildren()) do
        if v:IsA("MeshPart") or v.Name == "Head" then
            v.Material = Enum.Material.Neon
            v.Color = Color3.fromRGB(0, 0, 25)
            if not v:FindFirstChild("ZN_StarTexture") then
                for i=1,6 do local t=Instance.new("Texture",v); t.Name="ZN_StarTexture"; t.Texture="rbxassetid://15392542475"; t.Face=i; t.Transparency=0.4 end
            end
        elseif v:IsA("Accessory") or v:IsA("Clothing") or v:IsA("Shirt") or v:IsA("Pants") then
            v:Destroy()
        end
    end
end

-- [3D 魔法陣]
local CirclePart = nil
local function UpdateMagicCircle(root)
    if not Config.Visuals or not Config.MagicCircle then 
        if CirclePart then CirclePart:Destroy() CirclePart = nil end
        return 
    end
    if not CirclePart or not CirclePart.Parent then
        CirclePart = Instance.new("Part", workspace); CirclePart.Name="ZN_Visual_Part"; CirclePart.Size=Vector3.new(12,0.05,12); CirclePart.Anchored=true; CirclePart.CanCollide=false; CirclePart.Material="Neon"; CirclePart.Transparency=1
        local d = Instance.new("Decal", CirclePart); d.Face="Top"; d.Texture="rbxassetid://653733085"
    end
    if root then
        local color = Config.RGB and Color3.fromHSV(tick()%5/5,1,1) or Color3.fromRGB(130,0,255)
        CirclePart.CFrame = CFrame.new(root.Position-Vector3.new(0,2.8,0))*CFrame.Angles(0,tick()*2,0)
        CirclePart:FindFirstChildOfClass("Decal").Color3 = color
    end
end

--------------------------------------------------------------------------------
-- 5. 技能邏輯 (Skill Logic)
--------------------------------------------------------------------------------

-- [琦玉 (Saitama)]
local function Skill_Saitama(key)
    local Root = LocalPlayer.Character.HumanoidRootPart
    if key == "1" then -- 普通拳
        PlayAudio("2977754636", 3)
        CreateShockwave(Root.Position, Color3.fromRGB(255,50,50), 30, 0.3)
        Shake(3)
        ExecuteRealDamage(0.5) -- 傷害 0.5秒
    elseif key == "2" then -- 連續拳
        PlayAudio("536642316", 2)
        -- 殘影特效
        for i=1,5 do
            local c=Instance.new("Part",workspace); c.Size=Vector3.new(1,1,1); c.CFrame=Root.CFrame*CFrame.new(math.random(-5,5),0,math.random(-5,5)); c.Material="Neon"; c.Color=Color3.new(1,1,1); c.Transparency=0.5; c.Anchored=true; c.CanCollide=false; Debris:AddItem(c,0.1); task.wait(0.05)
        end
        ExecuteRealDamage(1.0) -- 傷害 1秒
    elseif key == "3" then -- 掀桌
        PlayAudio("8585081596", 4)
        local rock = Instance.new("Part", workspace); rock.Size=Vector3.new(10,10,10); rock.CFrame=Root.CFrame*CFrame.new(0,-5,-10); rock.Material="Slate"; rock.BrickColor=BrickColor.new("Dirt brown"); rock.Anchored=false; rock.Velocity=Vector3.new(0,100,0); Debris:AddItem(rock, 3)
        Shake(8)
        ExecuteRealDamage(0.8)
    elseif key == "4" then -- 認真毆打
        PlayAudio("6953048937", 5)
        local cc = Instance.new("ColorCorrectionEffect", Lighting); cc.Saturation=-1; cc.Contrast=0.5; Debris:AddItem(cc, 1)
        CreateShockwave(Root.Position, Color3.new(1,1,1), 150, 1.5)
        Shake(15)
        ExecuteRealDamage(1.5) -- 致命傷害
    end
end

-- [宇宙餓狼 (Garou)]
local function Skill_Garou(key)
    local Root = LocalPlayer.Character.HumanoidRootPart
    if key == "1" then -- 核分裂
        PlayAudio("1645854854", 3)
        local n = Instance.new("Part", workspace); n.Shape="Ball"; n.Size=Vector3.new(1,1,1); n.Material="Neon"; n.Color=Color3.fromRGB(255,100,0); n.CFrame=Root.CFrame; n.Anchored=true; n.CanCollide=false
        TweenService:Create(n, TweenInfo.new(0.5), {Size=Vector3.new(50,50,50), Transparency=1}):Play(); Debris:AddItem(n,1)
        ExecuteRealDamage(0.5)
    elseif key == "2" then -- 伽瑪射線
        PlayAudio("6953048937", 3)
        local b = Instance.new("Part", workspace); b.Size=Vector3.new(5,5,80); b.CFrame=Root.CFrame*CFrame.new(0,0,-40); b.Material="Neon"; b.Color=Color3.fromRGB(100,0,255); b.Anchored=true; b.CanCollide=false; b.Transparency=0.2
        TweenService:Create(b, TweenInfo.new(0.5), {Size=Vector3.new(0,0,80), Transparency=1}):Play(); Debris:AddItem(b,0.5)
        ExecuteRealDamage(0.5)
    elseif key == "3" then -- 重力
        CreateShockwave(Root.Position, Color3.fromRGB(50,0,100), 60, 1)
        ExecuteRealDamage(1.0)
    elseif key == "4" then -- 模式切換
        ApplyCosmicSkin(LocalPlayer.Character)
        PlayAudio("1496738980", 3)
        Shake(5)
    end
end

-- [宿儺 (Sukuna)]
local function Skill_Sukuna(key)
    local Root = LocalPlayer.Character.HumanoidRootPart
    if key == "1" then -- 解
        PlayAudio("5633641724", 2)
        local c = Instance.new("Part", workspace); c.Size=Vector3.new(0.2,15,5); c.CFrame=Root.CFrame*CFrame.new(0,0,-10)*CFrame.Angles(0,0,math.rad(45)); c.Material="Neon"; c.Color=Color3.new(1,0,0); c.Anchored=true; c.CanCollide=false
        TweenService:Create(c, TweenInfo.new(0.2), {Transparency=1}):Play(); Debris:AddItem(c,0.2)
        ExecuteRealDamage(0.3)
    elseif key == "2" then -- 捌
        PlayAudio("5633641724", 2.5)
        ExecuteRealDamage(0.8) -- 連續傷害
    elseif key == "3" then -- 開
        PlayAudio("8585081596", 3)
        local f = Instance.new("Part", workspace); f.Shape="Ball"; f.Size=Vector3.new(5,5,5); f.CFrame=Root.CFrame*CFrame.new(0,10,-10); f.Material="Neon"; f.Color=Color3.fromRGB(255,100,0); f.Anchored=true
        TweenService:Create(f, TweenInfo.new(1), {Size=Vector3.new(60,60,60), Transparency=1}):Play(); Debris:AddItem(f,1)
        ExecuteRealDamage(1.5)
    elseif key == "4" then -- 領域
        PlayAudio("1496738980", 2)
        local s = Instance.new("Part", workspace); s.Shape="Cylinder"; s.Size=Vector3.new(1,150,150); s.CFrame=Root.CFrame*CFrame.Angles(0,0,math.rad(90)); s.Material="ForceField"; s.Color=Color3.new(1,0,0); s.Anchored=true; s.CanCollide=false; Debris:AddItem(s,5)
        Shake(10)
        ExecuteRealDamage(2.0)
    end
end

local function CastSkill(key)
    if Config.Mode == "Saitama" then Skill_Saitama(key)
    elseif Config.Mode == "Garou" then Skill_Garou(key)
    elseif Config.Mode == "Sukuna" then Skill_Sukuna(key) end
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.One then CastSkill("1") end
    if input.KeyCode == Enum.KeyCode.Two then CastSkill("2") end
    if input.KeyCode == Enum.KeyCode.Three then CastSkill("3") end
    if input.KeyCode == Enum.KeyCode.Four then CastSkill("4") end
end)

--------------------------------------------------------------------------------
-- 6. Fluent UI 與 手機 HUD
--------------------------------------------------------------------------------
local Window = Fluent:CreateWindow({
    Title = "SYSTEM: MYTHOLOGY v29", SubTitle = PlatformName,
    TabWidth = 160, Size = UDim2.fromOffset(580, 460), Acrylic = true, Theme = "Amethyst", MinimizeKey = Enum.KeyCode.RightControl
})

local Tabs = {
    Main = Window:AddTab({ Title = "角色 (Heroes)", Icon = "user" }),
    Settings = Window:AddTab({ Title = "設定 (Settings)", Icon = "settings" })
}

-- Mobile HUD
local HUD = Instance.new("ScreenGui", CoreGui); HUD.Name = "ZhenNai_HUD_v29"
local SkillBar = nil

local function CreateSkillBar()
    if not IsMobile then return end
    if SkillBar then SkillBar:Destroy() end
    SkillBar = Instance.new("Frame", HUD); SkillBar.Size=UDim2.new(0,60,0,250); SkillBar.Position=UDim2.new(0.9,0,0.4,0); SkillBar.BackgroundTransparency=1; SkillBar.Visible=false
    local keys = {"4","3","2","1"}
    for i,k in ipairs(keys) do
        local b=Instance.new("TextButton",SkillBar); b.Size=UDim2.new(0,55,0,55); b.Position=UDim2.new(0,0,0,(i-1)*60); b.BackgroundColor3=Color3.new(0,0,0); b.BackgroundTransparency=0.3; b.Text=k; b.TextColor3=Color3.new(1,1,1); b.Font=Enum.Font.GothamBlack; b.TextSize=20
        Instance.new("UICorner",b).CornerRadius=UDim.new(0.5,0); local s=Instance.new("UIStroke",b); s.Color=Color3.fromRGB(255,50,50); s.Thickness=2
        b.MouseButton1Click:Connect(function() CastSkill(k) end)
    end
end
CreateSkillBar()

-- UI Options
local function FindPlayer(str)
    if not str or str == "" then return nil end
    for _, p in pairs(Players:GetPlayers()) do if p~=LocalPlayer and (p.Name:lower():find(str:lower()) or p.DisplayName:lower():find(str:lower())) then return p end end return nil
end

Tabs.Main:AddDropdown("Mode", {
    Title = "選擇英雄模組",
    Values = {"None", "Saitama", "Garou", "Sukuna"},
    Default = "None",
    Callback = function(v)
        Config.Mode = v
        Fluent:Notify({Title="模組載入", Content=v, Duration=2})
        if IsMobile and SkillBar then SkillBar.Visible = (v ~= "None") end
    end
})

Tabs.Main:AddInput("Target", {Title = "鎖定目標 (造成傷害必需)", Placeholder = "玩家名字", Callback = function(v) 
    Config.TargetName = v; local t = FindPlayer(v)
    if t then Config.CurrentTarget = t; Fluent:Notify({Title="鎖定", Content=t.Name, Duration=2}) end
end})

Tabs.Main:AddToggle("RealDamage", {Title = "開啟實戰傷害 (Fling Damage)", Default = false }):OnChanged(function(v) Config.RealDamage = v end)

Tabs.Settings:AddToggle("Visuals", {Title = "特效總開關", Default = true }):OnChanged(function(v) Config.Visuals = v end)
Tabs.Settings:AddToggle("AntiVoid", {Title = "防虛空 (Anti-Void)", Default = true }):OnChanged(function(v) Config.AntiVoid = v end)
Tabs.Settings:AddToggle("Invis", {Title = "隱形", Default = false }):OnChanged(function(v) Config.Invisible = v end)
Tabs.Settings:AddSlider("Speed", {Title = "速度", Default = 100, Min = 16, Max = 500, Rounding = 1, Callback = function(v) Config.Speed = v end})
Tabs.Settings:AddToggle("SpeedOn", {Title = "啟用速度", Default = false }):OnChanged(function(v) Config.SpeedEnabled = v end)

-- Mobile Menu Btn
if IsMobile then
    local MB = Instance.new("TextButton", HUD); MB.Size=UDim2.new(0,55,0,55); MB.Position=UDim2.new(0,20,0,50); MB.BackgroundColor3=Color3.new(0,0,0); MB.BackgroundTransparency=0.3; MB.Text="M"; MB.TextColor3=Color3.new(0,1,0); Instance.new("UICorner",MB).CornerRadius=UDim.new(0.5,0); Instance.new("UIStroke",MB).Color=Color3.new(0,1,0)
    MB.MouseButton1Click:Connect(function() pcall(function() Fluent:ToggleWindow() end) end)
end

--------------------------------------------------------------------------------
-- 7. 核心循環 Loop (修復版防虛空)
--------------------------------------------------------------------------------
RunService.RenderStepped:Connect(function()
    local Char = LocalPlayer.Character; if not Char then return end
    UpdateMagicCircle(Char.HumanoidRootPart)
    
    if Config.Invisible then
        if Char:FindFirstChild("Humanoid") then Char.Humanoid.DisplayDistanceType=Enum.HumanoidDisplayDistanceType.None end
        for _, v in pairs(Char:GetDescendants()) do if v:IsA("BasePart") and v.Name~="HumanoidRootPart" then v.Transparency=1; v.CanCollide=false elseif v:IsA("Decal") then v.Transparency=1 end end
    end
    
    -- Hitbox
    if Config.Hitbox then
        for _, p in pairs(Players:GetPlayers()) do
            if p~=LocalPlayer and p.Character and p.Character:FindFirstChild("Head") then
                p.Character.Head.Size = Vector3.new(Config.HitboxSize, Config.HitboxSize, Config.HitboxSize)
                p.Character.Head.Transparency = 0.6; p.Character.Head.CanCollide = false
            end
        end
    end
end)

RunService.Heartbeat:Connect(function()
    local Char = LocalPlayer.Character; if not Char then return end
    local Hum = Char:FindFirstChild("Humanoid")
    if Config.SpeedEnabled and Hum then Hum.WalkSpeed = Config.Speed end
    if Config.Noclip then for _,v in pairs(Char:GetChildren()) do if v:IsA("BasePart") then v.CanCollide=false end end end
    
    -- [絕對防虛空]
    if Config.AntiVoid and Char.HumanoidRootPart and Char.HumanoidRootPart.Position.Y < Config.VoidHeight then
        DeactivateFling(Char.HumanoidRootPart) -- 停止物理
        Char.HumanoidRootPart.Anchored = true -- 鎖死位置
        Char.HumanoidRootPart.CFrame = CFrame.new(Char.HumanoidRootPart.Position.X, 50, Char.HumanoidRootPart.Position.Z) -- 傳送
        Char.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
        task.delay(0.5, function() if Char.HumanoidRootPart then Char.HumanoidRootPart.Anchored = false end end) -- 解鎖
    end
    
    -- 宇宙餓狼皮膚
    if Config.Mode == "Garou" and tick()%0.5 < 0.1 then ApplyCosmicSkin(Char) end
end)

Fluent:Notify({Title = "SYSTEM: MYTHOLOGY", Content = "神話降臨。盡情享受你的力量。", Duration = 5})
