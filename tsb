-- [[ 頂點·幽靈 (APEX PHANTOM) - 重製版 V2.0 ]] --
-- [[ 修復：TSB彈飛自動續連、介面不顯示問題、防虛空優化 ]] --

do
    if not game:IsLoaded() then game.Loaded:Wait() end
    
    -- // 服務與變數 // --
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    local CoreGui = game:GetService("CoreGui")
    local TweenService = game:GetService("TweenService")
    local LocalPlayer = Players.LocalPlayer
    
    -- // 清理舊介面 // --
    for _, g in pairs(CoreGui:GetChildren()) do
        if g.Name == "APEX_PHANTOM_REMASTERED" then g:Destroy() end
    end

    -- // 設定 // --
    getgenv().Config = {
        Target = "",
        IsFlinging = false,
        AutoResume = true, -- 死亡後自動繼續
        AntiVoid = false,
        Speed = 16,
        Jump = 50
    }

    -- // TSB 核心邏輯 (原生寫法，不依賴外部庫) // --
    local FlingConnection = nil
    local function StartFling()
        if FlingConnection then FlingConnection:Disconnect() end
        
        getgenv().Config.IsFlinging = true
        
        -- 通知
        game.StarterGui:SetCore("SendNotification", {
            Title = "幽靈模式",
            Text = "鎖定目標: " .. getgenv().Config.Target .. "\n死亡後將自動繼續",
            Duration = 3
        })

        FlingConnection = RunService.Heartbeat:Connect(function()
            if not getgenv().Config.IsFlinging then 
                if FlingConnection then FlingConnection:Disconnect() end
                return 
            end

            local LP = Players.LocalPlayer
            local Char = LP.Character
            
            -- 尋找目標
            local TargetPlayer = nil
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= LP and string.sub(v.Name:lower(), 1, #getgenv().Config.Target) == getgenv().Config.Target:lower() then
                    TargetPlayer = v
                    break
                end
            end

            -- 執行彈飛
            if Char and Char:FindFirstChild("HumanoidRootPart") and TargetPlayer and TargetPlayer.Character and TargetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local T_RP = TargetPlayer.Character.HumanoidRootPart
                local L_RP = Char.HumanoidRootPart
                
                -- 預測位置並附著
                L_RP.CFrame = T_RP.CFrame * CFrame.new(0, 0, 0)
                
                -- 旋轉與速度暴力賦值
                local Vel = Vector3.new(999999, 999999, 999999)
                L_RP.AssemblyLinearVelocity = Vel
                L_RP.AssemblyAngularVelocity = Vel
                L_RP.Velocity = Vel
                
                -- 穿牆與去重力
                for _, part in pairs(Char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                        part.Massless = true
                        part.Velocity = Vel
                    end
                end
            else
                -- 如果找不到目標或自己死亡，暫時隱身或歸零等待重生
                if Char and Char:FindFirstChild("HumanoidRootPart") then
                    Char.HumanoidRootPart.Velocity = Vector3.zero
                end
            end
        end)
    end

    local function StopFling()
        getgenv().Config.IsFlinging = false
        if FlingConnection then FlingConnection:Disconnect() end
        
        local Char = Players.LocalPlayer.Character
        if Char and Char:FindFirstChild("HumanoidRootPart") then
            Char.HumanoidRootPart.Velocity = Vector3.zero
            Char.HumanoidRootPart.AssemblyAngularVelocity = Vector3.zero
        end
        
        game.StarterGui:SetCore("SendNotification", {Title = "系統", Text = "已停止彈飛", Duration = 2})
    end

    -- // 自動續連邏輯 (死亡後自動重啟) // --
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        if getgenv().Config.IsFlinging and getgenv().Config.AutoResume then
            task.wait(1) -- 等待角色加載
            game.StarterGui:SetCore("SendNotification", {Title = "復活", Text = "檢測到重生，繼續追擊...", Duration = 2})
            -- 這裡不需要重新呼叫 StartFling，因為 Heartbeat 會自動抓取新的 Character
            -- 但我們需要確保物理屬性被重置
            local hum = newChar:WaitForChild("Humanoid")
            local rp = newChar:WaitForChild("HumanoidRootPart")
        end
        
        -- 重置速度與跳躍
        if getgenv().Config.Speed > 16 then
            task.wait(0.5)
            local hum = newChar:WaitForChild("Humanoid")
            hum.WalkSpeed = getgenv().Config.Speed
            hum.JumpPower = getgenv().Config.Jump
        end
    end)

    -- // 防虛空邏輯 // --
    RunService.Stepped:Connect(function()
        if getgenv().Config.AntiVoid then
            local Char = Players.LocalPlayer.Character
            if Char and Char:FindFirstChild("HumanoidRootPart") then
                if Char.HumanoidRootPart.Position.Y < -20 then -- 提高判定線
                    Char.HumanoidRootPart.CFrame = Char.HumanoidRootPart.CFrame + Vector3.new(0, 100, 0)
                    Char.HumanoidRootPart.Velocity = Vector3.zero
                    Char.HumanoidRootPart.AssemblyLinearVelocity = Vector3.zero
                end
            end
        end
    end)


    -- // 介面建構 (UI Construction) // --
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "APEX_PHANTOM_REMASTERED"
    ScreenGui.Parent = CoreGui
    ScreenGui.IgnoreGuiInset = true

    -- 主框架
    local MainFrame = Instance.new("Frame")
    MainFrame.Name = "MainFrame"
    MainFrame.Size = UDim2.new(0, 500, 0, 350)
    MainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
    MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    MainFrame.BorderSizePixel = 0
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = ScreenGui

    -- 美化圓角與邊框
    local UICorner = Instance.new("UICorner", MainFrame)
    UICorner.CornerRadius = UDim.new(0, 10)
    local UIStroke = Instance.new("UIStroke", MainFrame)
    UIStroke.Color = Color3.fromRGB(138, 43, 226) -- 紫色霓虹
    UIStroke.Thickness = 2
    UIStroke.Transparency = 0

    -- 標題欄
    local Title = Instance.new("TextLabel", MainFrame)
    Title.Text = "APEX PHANTOM | TSB 專用版"
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.fromRGB(200, 200, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18
    
    -- 內容容器
    local Container = Instance.new("Frame", MainFrame)
    Container.Size = UDim2.new(0.9, 0, 0.8, 0)
    Container.Position = UDim2.new(0.05, 0, 0.15, 0)
    Container.BackgroundTransparency = 1
    
    local UIList = Instance.new("UIListLayout", Container)
    UIList.Padding = UDim.new(0, 10)
    UIList.SortOrder = Enum.SortOrder.LayoutOrder

    -- // UI 元件生成函數 // --
    local function CreateInput(placeholder, callback)
        local Box = Instance.new("TextBox", Container)
        Box.Size = UDim2.new(1, 0, 0, 40)
        Box.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Box.PlaceholderText = placeholder
        Box.Text = ""
        Box.TextColor3 = Color3.new(1,1,1)
        Box.Font = Enum.Font.Gotham
        Box.TextSize = 14
        Instance.new("UICorner", Box).CornerRadius = UDim.new(0, 6)
        
        Box.FocusLost:Connect(function()
            callback(Box.Text)
        end)
    end

    local function CreateToggle(text, callback)
        local Frame = Instance.new("Frame", Container)
        Frame.Size = UDim2.new(1, 0, 0, 40)
        Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
        
        local Label = Instance.new("TextLabel", Frame)
        Label.Text = text
        Label.Size = UDim2.new(0.7, 0, 1, 0)
        Label.Position = UDim2.new(0.05, 0, 0, 0)
        Label.BackgroundTransparency = 1
        Label.TextColor3 = Color3.new(1,1,1)
        Label.Font = Enum.Font.GothamSemibold
        Label.TextXAlignment = Enum.TextXAlignment.Left
        
        local Button = Instance.new("TextButton", Frame)
        Button.Size = UDim2.new(0, 60, 0, 30)
        Button.Position = UDim2.new(0.8, 0, 0.12, 0)
        Button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        Button.Text = "OFF"
        Button.TextColor3 = Color3.fromRGB(255, 100, 100)
        Instance.new("UICorner", Button).CornerRadius = UDim.new(0, 6)
        
        local Toggled = false
        Button.MouseButton1Click:Connect(function()
            Toggled = not Toggled
            if Toggled then
                Button.Text = "ON"
                Button.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
                Button.TextColor3 = Color3.fromRGB(0, 50, 0)
            else
                Button.Text = "OFF"
                Button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
                Button.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
            callback(Toggled)
        end)
    end
    
    local function CreateSlider(text, min, max, default, callback)
        local Frame = Instance.new("Frame", Container)
        Frame.Size = UDim2.new(1, 0, 0, 50)
        Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
        
        local Label = Instance.new("TextLabel", Frame)
        Label.Text = text .. ": " .. default
        Label.Size = UDim2.new(1, 0, 0.4, 0)
        Label.BackgroundTransparency = 1
        Label.TextColor3 = Color3.new(1,1,1)
        Label.Font = Enum.Font.Gotham
        
        local SlideBar = Instance.new("TextButton", Frame)
        SlideBar.Size = UDim2.new(0.9, 0, 0.2, 0)
        SlideBar.Position = UDim2.new(0.05, 0, 0.6, 0)
        SlideBar.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        SlideBar.Text = ""
        SlideBar.AutoButtonColor = false
        
        local Fill = Instance.new("Frame", SlideBar)
        Fill.Size = UDim2.new((default - min)/(max - min), 0, 1, 0)
        Fill.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
        
        local Dragging = false
        SlideBar.MouseButton1Down:Connect(function() Dragging = true end)
        UserInputService.InputEnded:Connect(function(input) 
            if input.UserInputType == Enum.UserInputType.MouseButton1 then Dragging = false end 
        end)
        
        UserInputService.InputChanged:Connect(function(input)
            if Dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
                local X = math.clamp((input.Position.X - SlideBar.AbsolutePosition.X) / SlideBar.AbsoluteSize.X, 0, 1)
                Fill.Size = UDim2.new(X, 0, 1, 0)
                local Val = math.floor(min + ((max - min) * X))
                Label.Text = text .. ": " .. Val
                callback(Val)
            end
        end)
    end

    -- // 構建功能列表 // --
    
    CreateInput("輸入目標名字 (支持簡寫)...", function(text)
        getgenv().Config.Target = text
    end)
    
    CreateToggle("啟動 TSB 黏著甩飛 (死亡自動連)", function(state)
        if state then
            if getgenv().Config.Target == "" then
                game.StarterGui:SetCore("SendNotification", {Title = "錯誤", Text = "請先輸入目標名字!", Duration = 3})
            else
                StartFling()
            end
        else
            StopFling()
        end
    end)
    
    CreateToggle("防虛空 (Anti-Void)", function(state)
        getgenv().Config.AntiVoid = state
    end)
    
    CreateSlider("移動速度 (WalkSpeed)", 16, 200, 16, function(val)
        getgenv().Config.Speed = val
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = val
        end
    end)
    
    CreateSlider("跳躍高度 (JumpPower)", 50, 400, 50, function(val)
        getgenv().Config.Jump = val
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = val
        end
    end)

    -- // 最小化按鈕 // --
    local ToggleBtn = Instance.new("ImageButton", ScreenGui)
    ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
    ToggleBtn.Position = UDim2.new(0.1, 0, 0.1, 0)
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    ToggleBtn.Image = "rbxassetid://13465637257" -- 幽靈圖標
    Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", ToggleBtn).Color = Color3.fromRGB(138, 43, 226)
    Instance.new("UIStroke", ToggleBtn).Thickness = 2
    
    local Open = true
    ToggleBtn.MouseButton1Click:Connect(function()
        Open = not Open
        MainFrame.Visible = Open
    end)

    -- 拖曳邏輯
    local dragging, dragInput, dragStart, startPos
    ToggleBtn.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = ToggleBtn.Position
        end
    end)
    ToggleBtn.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            ToggleBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
    end)

    game.StarterGui:SetCore("SendNotification", {Title = "加載完成", Text = "APEX 幽靈重製版已啟動", Duration = 3})
end
