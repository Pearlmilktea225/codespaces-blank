-- [[ 頂點·幽靈 (APEX PHANTOM) - V3.0 增強版 ]] --
-- [[ 更新：輸入式數值、透視/穿牆/無限跳、彈飛歸位 ]] --

do
    if not game:IsLoaded() then game.Loaded:Wait() end
    
    -- // 服務與變數 // --
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local UserInputService = game:GetService("UserInputService")
    local CoreGui = game:GetService("CoreGui")
    local Lighting = game:GetService("Lighting")
    local LocalPlayer = Players.LocalPlayer
    
    -- // 清理舊介面 // --
    for _, g in pairs(CoreGui:GetChildren()) do
        if g.Name == "APEX_PHANTOM_REMASTERED" then g:Destroy() end
    end

    -- // 設定 // --
    getgenv().Config = {
        Target = "",
        IsFlinging = false,
        AutoResume = true,
        AntiVoid = false,
        Speed = 16,
        Jump = 50,
        SavedPosition = nil, -- 用於儲存彈飛前的位置
        InfiniteJump = false,
        NoClip = false,
        ESP = false
    }

    -- // 功能函數 // --

    -- 1. 彈飛功能
    local FlingConnection = nil
    local function StartFling()
        if FlingConnection then FlingConnection:Disconnect() end
        
        local Char = LocalPlayer.Character
        if Char and Char:FindFirstChild("HumanoidRootPart") then
            -- 記錄當前位置
            getgenv().Config.SavedPosition = Char.HumanoidRootPart.CFrame
        end

        getgenv().Config.IsFlinging = true
        
        game.StarterGui:SetCore("SendNotification", {
            Title = "幽靈模式",
            Text = "鎖定目標: " .. getgenv().Config.Target,
            Duration = 3
        })

        FlingConnection = RunService.Heartbeat:Connect(function()
            if not getgenv().Config.IsFlinging then 
                if FlingConnection then FlingConnection:Disconnect() end
                return 
            end

            local LP = Players.LocalPlayer
            local Char = LP.Character
            
            local TargetPlayer = nil
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= LP and string.sub(v.Name:lower(), 1, #getgenv().Config.Target) == getgenv().Config.Target:lower() then
                    TargetPlayer = v
                    break
                end
            end

            if Char and Char:FindFirstChild("HumanoidRootPart") and TargetPlayer and TargetPlayer.Character and TargetPlayer.Character:FindFirstChild("HumanoidRootPart") then
                local T_RP = TargetPlayer.Character.HumanoidRootPart
                local L_RP = Char.HumanoidRootPart
                
                L_RP.CFrame = T_RP.CFrame * CFrame.new(0, 0, 0)
                
                local Vel = Vector3.new(999999, 999999, 999999)
                L_RP.AssemblyLinearVelocity = Vel
                L_RP.AssemblyAngularVelocity = Vel
                L_RP.Velocity = Vel
                
                for _, part in pairs(Char:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                        part.Massless = true
                        part.Velocity = Vel
                    end
                end
            elseif Char and Char:FindFirstChild("HumanoidRootPart") then
                Char.HumanoidRootPart.Velocity = Vector3.zero
            end
        end)
    end

    local function StopFling()
        getgenv().Config.IsFlinging = false
        if FlingConnection then FlingConnection:Disconnect() end
        
        local Char = Players.LocalPlayer.Character
        if Char and Char:FindFirstChild("HumanoidRootPart") then
            Char.HumanoidRootPart.Velocity = Vector3.zero
            Char.HumanoidRootPart.AssemblyAngularVelocity = Vector3.zero
            
            -- 回到地圖 (原位)
            if getgenv().Config.SavedPosition then
                task.wait(0.1)
                Char.HumanoidRootPart.CFrame = getgenv().Config.SavedPosition
                game.StarterGui:SetCore("SendNotification", {Title = "系統", Text = "已傳送回原位", Duration = 2})
            else
                -- 如果沒有記錄，傳送到安全高度
                Char.HumanoidRootPart.CFrame = CFrame.new(0, 100, 0)
                game.StarterGui:SetCore("SendNotification", {Title = "系統", Text = "已傳送至安全區", Duration = 2})
            end
        end
    end

    -- 2. ESP 透視
    local ESP_Holder = Instance.new("Folder", CoreGui)
    ESP_Holder.Name = "ESP_HOLDER"
    
    local function UpdateESP()
        ESP_Holder:ClearAllChildren()
        if not getgenv().Config.ESP then return end
        
        for _, v in pairs(Players:GetPlayers()) do
            if v ~= LocalPlayer and v.Character then
                local Highlight = Instance.new("Highlight")
                Highlight.Adornee = v.Character
                Highlight.Parent = ESP_Holder
                Highlight.FillColor = Color3.fromRGB(255, 0, 0)
                Highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
                Highlight.FillTransparency = 0.5
                Highlight.OutlineTransparency = 0
            end
        end
    end
    
    RunService.Stepped:Connect(function()
        if getgenv().Config.ESP then
            -- 簡單的檢查，若玩家剛重生需要補上 ESP
            for _, v in pairs(Players:GetPlayers()) do
                if v ~= LocalPlayer and v.Character and not ESP_Holder:FindFirstChild(v.Name) then
                     -- 這裡為了效能，通常用上面的 UpdateESP 統一刷新，或者用 ChildAdded 事件
                     -- 為了腳本簡潔，我們每 5 秒刷新一次 ESP 即可，或者依賴 toggle
                end
            end
        else
            ESP_Holder:ClearAllChildren()
        end
    end)
    -- 每3秒刷新一次確保新重生的玩家也有透視
    task.spawn(function()
        while true do
            task.wait(3)
            if getgenv().Config.ESP then UpdateESP() end
        end
    end)

    -- 3. 無限跳
    UserInputService.JumpRequest:Connect(function()
        if getgenv().Config.InfiniteJump then
            local Char = LocalPlayer.Character
            if Char and Char:FindFirstChild("Humanoid") then
                Char.Humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end
    end)

    -- 4. 穿牆
    RunService.Stepped:Connect(function()
        if getgenv().Config.NoClip then
            local Char = LocalPlayer.Character
            if Char then
                for _, part in pairs(Char:GetDescendants()) do
                    if part:IsA("BasePart") and part.CanCollide then
                        part.CanCollide = false
                    end
                end
            end
        end
    end)

    -- 角色重生事件
    LocalPlayer.CharacterAdded:Connect(function(newChar)
        local hum = newChar:WaitForChild("Humanoid")
        
        -- 自動續連彈飛
        if getgenv().Config.IsFlinging and getgenv().Config.AutoResume then
            task.wait(1)
            game.StarterGui:SetCore("SendNotification", {Title = "復活", Text = "繼續追擊...", Duration = 2})
        end
        
        -- 重置數值
        task.wait(0.5)
        if getgenv().Config.Speed ~= 16 then hum.WalkSpeed = getgenv().Config.Speed end
        if getgenv().Config.Jump ~= 50 then hum.JumpPower = getgenv().Config.Jump end
    end)

    -- // 介面 UI // --
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "APEX_PHANTOM_REMASTERED"
    ScreenGui.Parent = CoreGui
    ScreenGui.IgnoreGuiInset = true

    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Size = UDim2.new(0, 500, 0, 450) -- 加高介面以容納更多功能
    MainFrame.Position = UDim2.new(0.5, -250, 0.5, -225)
    MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 20)
    MainFrame.Active = true
    MainFrame.Draggable = true
    
    Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)
    local UIStroke = Instance.new("UIStroke", MainFrame)
    UIStroke.Color = Color3.fromRGB(138, 43, 226)
    UIStroke.Thickness = 2

    local Title = Instance.new("TextLabel", MainFrame)
    Title.Text = "APEX PHANTOM | TSB 增強版"
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.BackgroundTransparency = 1
    Title.TextColor3 = Color3.fromRGB(200, 200, 255)
    Title.Font = Enum.Font.GothamBold
    Title.TextSize = 18

    local Container = Instance.new("ScrollingFrame", MainFrame)
    Container.Size = UDim2.new(0.9, 0, 0.85, 0)
    Container.Position = UDim2.new(0.05, 0, 0.12, 0)
    Container.BackgroundTransparency = 1
    Container.ScrollBarThickness = 4
    
    local UIList = Instance.new("UIListLayout", Container)
    UIList.Padding = UDim.new(0, 10)
    UIList.SortOrder = Enum.SortOrder.LayoutOrder
    
    Container.AutomaticCanvasSize = Enum.AutomaticSize.Y

    -- UI 函數
    local function CreateSection(text)
        local Label = Instance.new("TextLabel", Container)
        Label.Text = "--- " .. text .. " ---"
        Label.Size = UDim2.new(1, 0, 0, 25)
        Label.BackgroundTransparency = 1
        Label.TextColor3 = Color3.fromRGB(150, 150, 150)
        Label.Font = Enum.Font.Code
    end

    local function CreateToggle(text, callback)
        local Frame = Instance.new("Frame", Container)
        Frame.Size = UDim2.new(1, 0, 0, 40)
        Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
        
        local Label = Instance.new("TextLabel", Frame)
        Label.Text = text
        Label.Size = UDim2.new(0.7, 0, 1, 0)
        Label.Position = UDim2.new(0.05, 0, 0, 0)
        Label.BackgroundTransparency = 1
        Label.TextColor3 = Color3.new(1,1,1)
        Label.Font = Enum.Font.GothamSemibold
        Label.TextXAlignment = Enum.TextXAlignment.Left
        
        local Button = Instance.new("TextButton", Frame)
        Button.Size = UDim2.new(0, 60, 0, 30)
        Button.Position = UDim2.new(0.8, 0, 0.12, 0)
        Button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
        Button.Text = "OFF"
        Button.TextColor3 = Color3.fromRGB(255, 100, 100)
        Instance.new("UICorner", Button).CornerRadius = UDim.new(0, 6)
        
        local Toggled = false
        Button.MouseButton1Click:Connect(function()
            Toggled = not Toggled
            if Toggled then
                Button.Text = "ON"
                Button.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
                Button.TextColor3 = Color3.fromRGB(0, 50, 0)
            else
                Button.Text = "OFF"
                Button.BackgroundColor3 = Color3.fromRGB(50, 50, 60)
                Button.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
            callback(Toggled)
        end)
    end

    local function CreateInputBox(title, default, callback)
        local Frame = Instance.new("Frame", Container)
        Frame.Size = UDim2.new(1, 0, 0, 50)
        Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
        
        local Label = Instance.new("TextLabel", Frame)
        Label.Text = title
        Label.Size = UDim2.new(0.4, 0, 1, 0)
        Label.Position = UDim2.new(0.05, 0, 0, 0)
        Label.BackgroundTransparency = 1
        Label.TextColor3 = Color3.new(1,1,1)
        Label.Font = Enum.Font.Gotham
        Label.TextXAlignment = Enum.TextXAlignment.Left
        
        local Box = Instance.new("TextBox", Frame)
        Box.Size = UDim2.new(0.4, 0, 0.6, 0)
        Box.Position = UDim2.new(0.55, 0, 0.2, 0)
        Box.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
        Box.Text = tostring(default)
        Box.TextColor3 = Color3.fromRGB(100, 255, 100)
        Box.Font = Enum.Font.GothamBold
        Instance.new("UICorner", Box).CornerRadius = UDim.new(0, 4)
        
        Box.FocusLost:Connect(function()
            local num = tonumber(Box.Text)
            if num then
                callback(num)
            else
                Box.Text = tostring(default) -- 恢復預設
            end
        end)
    end

    local function CreateNormalInput(placeholder, callback)
        local Box = Instance.new("TextBox", Container)
        Box.Size = UDim2.new(1, 0, 0, 40)
        Box.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
        Box.PlaceholderText = placeholder
        Box.Text = ""
        Box.TextColor3 = Color3.new(1,1,1)
        Box.Font = Enum.Font.Gotham
        Box.TextSize = 14
        Instance.new("UICorner", Box).CornerRadius = UDim.new(0, 6)
        
        Box.FocusLost:Connect(function()
            callback(Box.Text)
        end)
    end

    -- // 構建功能列表 // --

    CreateSection("核心功能")
    CreateNormalInput("輸入目標名字 (支持簡寫)...", function(text)
        getgenv().Config.Target = text
    end)
    
    CreateToggle("啟動黏著甩飛 (關閉後回原位)", function(state)
        if state then
            if getgenv().Config.Target == "" then
                game.StarterGui:SetCore("SendNotification", {Title = "錯誤", Text = "請先輸入目標名字!", Duration = 3})
            else
                StartFling()
            end
        else
            StopFling()
        end
    end)

    CreateSection("角色數值 (輸入數字)")
    CreateInputBox("移動速度 (WalkSpeed)", 16, function(val)
        getgenv().Config.Speed = val
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.WalkSpeed = val
        end
    end)

    CreateInputBox("跳躍高度 (JumpPower)", 50, function(val)
        getgenv().Config.Jump = val
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid.JumpPower = val
        end
    end)

    CreateSection("輔助外掛")
    CreateToggle("玩家透視 (ESP)", function(state)
        getgenv().Config.ESP = state
        UpdateESP()
    end)

    CreateToggle("無限跳躍 (Infinite Jump)", function(state)
        getgenv().Config.InfiniteJump = state
    end)

    CreateToggle("穿牆模式 (NoClip)", function(state)
        getgenv().Config.NoClip = state
    end)
    
    CreateToggle("全亮模式 (Full Bright)", function(state)
        if state then
            Lighting.Brightness = 2
            Lighting.ClockTime = 14
            Lighting.GlobalShadows = false
            Lighting.Ambient = Color3.new(1,1,1)
        else
            Lighting.Brightness = 1
            Lighting.ClockTime = 12
            Lighting.GlobalShadows = true
            Lighting.Ambient = Color3.fromRGB(138, 138, 138)
        end
    end)
    
    CreateToggle("防虛空 (Anti-Void)", function(state)
        getgenv().Config.AntiVoid = state
    end)

    -- // 最小化按鈕 // --
    local ToggleBtn = Instance.new("ImageButton", ScreenGui)
    ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
    ToggleBtn.Position = UDim2.new(0.1, 0, 0.1, 0)
    ToggleBtn.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    ToggleBtn.Image = "rbxassetid://13465637257"
    Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 10)
    Instance.new("UIStroke", ToggleBtn).Color = Color3.fromRGB(138, 43, 226)
    Instance.new("UIStroke", ToggleBtn).Thickness = 2
    
    local Open = true
    ToggleBtn.MouseButton1Click:Connect(function()
        Open = not Open
        MainFrame.Visible = Open
    end)

    game.StarterGui:SetCore("SendNotification", {Title = "加載完成", Text = "V3.0 增強版已啟動", Duration = 3})
end
